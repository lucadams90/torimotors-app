<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TO.RI. MOTORS GEST - Cloud Edition</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema Gestionale Automotive Professionale">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TORI GEST">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF for receipt generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD-u0q6IBYpGxJaHUHoZqFqeFz2ONzLmXo",
            authDomain: "tori-gest.firebaseapp.com",
            projectId: "tori-gest",
            storageBucket: "tori-gest.firebasestorage.app",
            messagingSenderId: "494611155773",
            appId: "1:494611155773:web:aa077e1ad26beb43f11354"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Receipt counter management
        const getNextReceiptNumber = async () => {
            const counterDoc = await db.collection('settings').doc('receiptCounter').get();
            if (!counterDoc.exists) {
                await db.collection('settings').doc('receiptCounter').set({ count: 1 });
                return 1;
            }
            const newCount = counterDoc.data().count + 1;
            await db.collection('settings').doc('receiptCounter').update({ count: newCount });
            return newCount;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [vehicles, setVehicles] = useState([]);
            const [currentView, setCurrentView] = useState('parco');
            const [selectedVehicle, setSelectedVehicle] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [sidebarOpen, setSidebarOpen] = useState(false);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    setUser(user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) {
                    setVehicles([]);
                    return;
                }

                const unsubscribe = db.collection('vehicles')
                    .where('userId', '==', user.uid)
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const vehiclesData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        setVehicles(vehiclesData);
                    }, (error) => {
                        console.error('Error loading vehicles:', error);
                    });

                return () => unsubscribe();
            }, [user]);

            const addVehicle = async (vehicle) => {
                try {
                    await db.collection('vehicles').add({
                        ...vehicle,
                        userId: user.uid,
                        expenses: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error adding vehicle:', error);
                    alert('Errore nel salvare il veicolo');
                }
            };

            const updateVehicle = async (id, updates) => {
                try {
                    await db.collection('vehicles').doc(id).update(updates);
                    // Update local state for immediate UI update
                    if (selectedVehicle && selectedVehicle.id === id) {
                        setSelectedVehicle({ ...selectedVehicle, ...updates });
                    }
                } catch (error) {
                    console.error('Error updating vehicle:', error);
                    alert('Errore nell\'aggiornare il veicolo');
                }
            };

            const deleteVehicle = async (id) => {
                if (confirm('Sei sicuro di voler eliminare questo veicolo?')) {
                    try {
                        await db.collection('vehicles').doc(id).delete();
                        setSelectedVehicle(null);
                    } catch (error) {
                        console.error('Error deleting vehicle:', error);
                        alert('Errore nell\'eliminare il veicolo');
                    }
                }
            };

            const addExpense = async (vehicleId, expense) => {
                const vehicle = vehicles.find(v => v.id === vehicleId);
                if (vehicle) {
                    const newExpense = { ...expense, id: Date.now() };
                    await updateVehicle(vehicleId, {
                        expenses: [...(vehicle.expenses || []), newExpense]
                    });
                }
            };

            const deleteExpense = async (vehicleId, expenseId) => {
                const vehicle = vehicles.find(v => v.id === vehicleId);
                if (vehicle) {
                    await updateVehicle(vehicleId, {
                        expenses: vehicle.expenses.filter(e => e.id !== expenseId)
                    });
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Error logging out:', error);
                }
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-800 to-blue-900 flex items-center justify-center">
                        <div className="text-white text-center">
                            <i className="fas fa-spinner fa-spin text-6xl mb-4"></i>
                            <p className="text-xl">Caricamento...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <LoginPage />;
            }

            return (
                <div className="flex h-screen bg-gray-100 overflow-hidden">
                    <Sidebar 
                        currentView={currentView}
                        setCurrentView={setCurrentView}
                        sidebarOpen={sidebarOpen}
                        setSidebarOpen={setSidebarOpen}
                        vehiclesCount={vehicles.length}
                    />

                    <div className="flex-1 flex flex-col overflow-hidden">
                        <Header 
                            setSidebarOpen={setSidebarOpen}
                            onLogout={handleLogout}
                            userEmail={user.email}
                        />

                        <main className="flex-1 overflow-y-auto bg-gray-50">
                            {currentView === 'parco' && (
                                <ParcoAuto
                                    vehicles={vehicles}
                                    searchQuery={searchQuery}
                                    setSearchQuery={setSearchQuery}
                                    filterStatus={filterStatus}
                                    setFilterStatus={setFilterStatus}
                                    onSelectVehicle={setSelectedVehicle}
                                    onAddVehicle={() => {
                                        setSelectedVehicle(null);
                                        setIsEditing(true);
                                    }}
                                />
                            )}

                            {currentView === 'logistica' && (
                                <Logistica vehicles={vehicles} onSelectVehicle={setSelectedVehicle} />
                            )}

                            {currentView === 'analisi' && (
                                <AnalisiMargini vehicles={vehicles} />
                            )}

                            {selectedVehicle && !isEditing && (
                                <VehicleDetail
                                    vehicle={selectedVehicle}
                                    onClose={() => setSelectedVehicle(null)}
                                    onEdit={() => setIsEditing(true)}
                                    onDelete={deleteVehicle}
                                    onAddExpense={addExpense}
                                    onDeleteExpense={deleteExpense}
                                    onUpdate={updateVehicle}
                                />
                            )}

                            {isEditing && (
                                <VehicleForm
                                    vehicle={selectedVehicle}
                                    onSave={async (vehicle) => {
                                        if (selectedVehicle) {
                                            await updateVehicle(selectedVehicle.id, vehicle);
                                            setSelectedVehicle({ ...selectedVehicle, ...vehicle });
                                        } else {
                                            await addVehicle(vehicle);
                                        }
                                        setIsEditing(false);
                                    }}
                                    onCancel={() => {
                                        setIsEditing(false);
                                        if (!selectedVehicle) setSelectedVehicle(null);
                                    }}
                                />
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        function LoginPage() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    console.error('Login error:', error);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        setError('Email o password non corretti');
                    } else if (error.code === 'auth/invalid-email') {
                        setError('Email non valida');
                    } else {
                        setError('Errore durante l\'accesso. Riprova.');
                    }
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-800 via-slate-700 to-blue-900 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                        <div className="bg-gradient-to-r from-slate-700 to-blue-800 text-white p-8 text-center rounded-t-2xl">
                            <i className="fas fa-car text-6xl mb-4"></i>
                            <h1 className="text-3xl font-bold mb-2">TO.RI. MOTORS GEST</h1>
                            <p className="text-slate-200">Cloud Edition</p>
                            <div className="mt-3 inline-flex items-center bg-white/20 px-3 py-1 rounded-full text-xs">
                                <i className="fas fa-cloud mr-2"></i>
                                Dati salvati su cloud sicuro
                            </div>
                        </div>
                        <div className="p-8">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Accedi</h2>
                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
                                    <i className="fas fa-exclamation-circle mr-2"></i>{error}
                                </div>
                            )}
                            <form onSubmit={handleLogin} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        <i className="fas fa-envelope mr-2 text-blue-600"></i>Email
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        required
                                        autoFocus
                                        disabled={loading}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        <i className="fas fa-lock mr-2 text-blue-600"></i>Password
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        required
                                        disabled={loading}
                                    />
                                </div>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 px-4 rounded-lg transition-all disabled:opacity-50"
                                >
                                    {loading ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin mr-2"></i>
                                            Accesso in corso...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-sign-in-alt mr-2"></i>
                                            Accedi
                                        </>
                                    )}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function Sidebar({ currentView, setCurrentView, sidebarOpen, setSidebarOpen, vehiclesCount }) {
            const menuItems = [
                { id: 'parco', icon: 'fa-warehouse', label: 'Parco Auto', badge: vehiclesCount },
                { id: 'logistica', icon: 'fa-truck', label: 'Logistica/Trasporti' },
                { id: 'analisi', icon: 'fa-chart-line', label: 'Analisi Margini' }
            ];

            return (
                <>
                    {sidebarOpen && (
                        <div 
                            className="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden"
                            onClick={() => setSidebarOpen(false)}
                        />
                    )}

                    <aside className={`
                        fixed lg:static inset-y-0 left-0 z-30
                        w-64 bg-slate-800 text-white transform transition-transform duration-300
                        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}
                    `}>
                        <div className="h-full flex flex-col">
                            <div className="p-6 border-b border-slate-700">
                                <div className="flex items-center space-x-3">
                                    <i className="fas fa-car text-3xl text-blue-400"></i>
                                    <div>
                                        <h1 className="text-xl font-bold">TO.RI. MOTORS</h1>
                                        <p className="text-xs text-slate-400 flex items-center">
                                            <i className="fas fa-cloud mr-1"></i>Cloud Edition
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <nav className="flex-1 p-4 space-y-2">
                                {menuItems.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => {
                                            setCurrentView(item.id);
                                            setSidebarOpen(false);
                                        }}
                                        className={`w-full flex items-center justify-between px-4 py-3 rounded-lg transition-colors ${
                                            currentView === item.id
                                                ? 'bg-blue-600 text-white'
                                                : 'text-slate-300 hover:bg-slate-700'
                                        }`}
                                    >
                                        <div className="flex items-center space-x-3">
                                            <i className={`fas ${item.icon} text-lg`}></i>
                                            <span className="font-medium">{item.label}</span>
                                        </div>
                                        {item.badge !== undefined && (
                                            <span className="bg-slate-700 text-white text-xs font-bold px-2 py-1 rounded-full">
                                                {item.badge}
                                            </span>
                                        )}
                                    </button>
                                ))}
                            </nav>

                            <div className="p-4 border-t border-slate-700">
                                <div className="bg-green-900/30 border border-green-700/50 rounded-lg p-3 text-xs text-green-300">
                                    <i className="fas fa-check-circle mr-2"></i>
                                    Connesso al cloud
                                </div>
                            </div>
                        </div>
                    </aside>
                </>
            );
        }

        function Header({ setSidebarOpen, onLogout, userEmail }) {
            return (
                <header className="bg-white border-b border-gray-200 px-4 lg:px-6 py-4">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-4">
                            <button
                                onClick={() => setSidebarOpen(true)}
                                className="lg:hidden text-gray-600 hover:text-gray-800"
                            >
                                <i className="fas fa-bars text-xl"></i>
                            </button>
                            <div className="text-sm text-gray-600">
                                <i className="fas fa-calendar-alt mr-2"></i>
                                {new Date().toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                            </div>
                        </div>
                        <div className="flex items-center space-x-4">
                            <span className="text-sm text-gray-600 hidden md:inline">
                                <i className="fas fa-user-circle mr-2"></i>
                                {userEmail}
                            </span>
                            <button
                                onClick={onLogout}
                                className="text-gray-600 hover:text-red-600 transition-colors"
                                title="Logout"
                            >
                                <i className="fas fa-sign-out-alt text-xl"></i>
                            </button>
                        </div>
                    </div>
                </header>
            );
        }

        // Continue with ParcoAuto and other components in next message due to length...
        
        function ParcoAuto({ vehicles, searchQuery, setSearchQuery, filterStatus, setFilterStatus, onSelectVehicle, onAddVehicle }) {
            const filteredVehicles = vehicles.filter(v => {
                const matchesSearch = !searchQuery || 
                    v.brand?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    v.model?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                    v.plate?.toLowerCase().includes(searchQuery.toLowerCase());

                const matchesFilter = filterStatus === 'all' ||
                    (filterStatus === 'da-trasportare' && !v.transportOrdered && !v.inStock) ||
                    (filterStatus === 'in-stock' && v.inStock && !v.sold) ||
                    (filterStatus === 'in-arrivo' && v.transportOrdered && !v.delivered) ||
                    (filterStatus === 'disponibili' && (v.delivered || v.inStock) && !v.sold) ||
                    (filterStatus === 'vendute' && v.sold);

                return matchesSearch && matchesFilter;
            });

            const calculateMargin = (v) => {
                const expenses = (v.expenses || []).reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0);
                const totalCost = (parseFloat(v.purchasePrice) || 0) + expenses;
                const revenue = parseFloat(v.salePrice) || 0;
                return revenue - totalCost;
            };

            return (
                <div className="p-4 lg:p-6 space-y-6">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h1 className="text-2xl lg:text-3xl font-bold text-gray-800">
                            <i className="fas fa-warehouse mr-3 text-blue-600"></i>
                            Parco Auto
                        </h1>
                        <button
                            onClick={onAddVehicle}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors shadow-lg"
                        >
                            <i className="fas fa-plus mr-2"></i>
                            Aggiungi Auto
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow p-4 space-y-4">
                        <div className="relative">
                            <i className="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                placeholder="Cerca per marca, modello o targa..."
                                className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {[
                                { id: 'all', label: 'Tutte', count: vehicles.length },
                                { id: 'da-trasportare', label: 'Da Trasportare', count: vehicles.filter(v => !v.transportOrdered && !v.inStock).length },
                                { id: 'in-stock', label: 'In Stock', count: vehicles.filter(v => v.inStock && !v.sold).length },
                                { id: 'in-arrivo', label: 'In Arrivo', count: vehicles.filter(v => v.transportOrdered && !v.delivered).length },
                                { id: 'disponibili', label: 'Disponibili', count: vehicles.filter(v => (v.delivered || v.inStock) && !v.sold).length },
                                { id: 'vendute', label: 'Vendute', count: vehicles.filter(v => v.sold).length }
                            ].map(filter => (
                                <button
                                    key={filter.id}
                                    onClick={() => setFilterStatus(filter.id)}
                                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                                        filterStatus === filter.id
                                            ? 'bg-blue-600 text-white'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    {filter.label} ({filter.count})
                                </button>
                            ))}
                        </div>
                    </div>

                    {filteredVehicles.length === 0 ? (
                        <div className="bg-white rounded-lg shadow p-12 text-center">
                            <i className="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                            <p className="text-gray-500 text-lg">Nessun veicolo trovato</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredVehicles.map(vehicle => (
                                <div
                                    key={vehicle.id}
                                    onClick={() => onSelectVehicle(vehicle)}
                                    className="bg-white rounded-lg shadow hover:shadow-xl transition-shadow cursor-pointer overflow-hidden"
                                >
                                    <div className="bg-gradient-to-r from-slate-700 to-blue-800 text-white p-4">
                                        <h3 className="font-bold text-xl mb-1">{vehicle.brand} {vehicle.model}</h3>
                                        <p className="text-sm text-slate-200">{vehicle.plate}</p>
                                    </div>
                                    <div className="p-4 space-y-3">
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Telaio:</span>
                                            <span className="font-medium">{vehicle.vin}</span>
                                        </div>
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">KM:</span>
                                            <span className="font-medium">{parseInt(vehicle.km || 0).toLocaleString('it-IT')}</span>
                                        </div>
                                        {vehicle.fuelType && (
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-600">Alimentazione:</span>
                                                <span className="font-medium text-green-600">
                                                    {vehicle.fuelType === 'benzina' && 'â›½ Benzina'}
                                                    {vehicle.fuelType === 'diesel' && 'ðŸš› Diesel'}
                                                    {vehicle.fuelType === 'benzina-metano' && 'â›½ðŸ”µ Benzina/Metano'}
                                                    {vehicle.fuelType === 'benzina-gpl' && 'â›½ðŸŸ  Benzina/GPL'}
                                                    {vehicle.fuelType === 'hybrid' && 'ðŸ”‹ Hybrid'}
                                                    {vehicle.fuelType === 'elettrico' && 'âš¡ Elettrico'}
                                                </span>
                                            </div>
                                        )}
                                        <div className="flex justify-between text-sm">
                                            <span className="text-gray-600">Regime:</span>
                                            <span className={`font-medium ${vehicle.taxRegime === 'margine' ? 'text-purple-600' : 'text-blue-600'}`}>
                                                {vehicle.taxRegime === 'margine' ? 'Margine' : 'IVA Esposta'}
                                            </span>
                                        </div>
                                        <div className="pt-3 border-t flex flex-wrap gap-2">
                                            {!vehicle.transportOrdered && !vehicle.inStock && (
                                                <span className="bg-orange-100 text-orange-700 text-xs px-3 py-1 rounded-full font-medium">
                                                    <i className="fas fa-clock mr-1"></i>Da Trasportare
                                                </span>
                                            )}
                                            {vehicle.inStock && !vehicle.sold && (
                                                <span className="bg-purple-100 text-purple-700 text-xs px-3 py-1 rounded-full font-medium">
                                                    <i className="fas fa-warehouse mr-1"></i>In Stock
                                                </span>
                                            )}
                                            {vehicle.transportOrdered && !vehicle.delivered && (
                                                <span className="bg-yellow-100 text-yellow-700 text-xs px-3 py-1 rounded-full font-medium">
                                                    <i className="fas fa-truck mr-1"></i>In Arrivo
                                                </span>
                                            )}
                                            {vehicle.delivered && !vehicle.sold && (
                                                <span className="bg-green-100 text-green-700 text-xs px-3 py-1 rounded-full font-medium">
                                                    <i className="fas fa-check mr-1"></i>Disponibile
                                                </span>
                                            )}
                                            {vehicle.sold && (
                                                <span className="bg-blue-100 text-blue-700 text-xs px-3 py-1 rounded-full font-medium">
                                                    <i className="fas fa-handshake mr-1"></i>Venduta
                                                </span>
                                            )}
                                        </div>
                                        {vehicle.sold && (
                                            <div className="pt-3 border-t">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-sm text-gray-600">Margine:</span>
                                                    <span className={`font-bold text-lg ${calculateMargin(vehicle) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                        â‚¬{calculateMargin(vehicle).toLocaleString('it-IT', { minimumFractionDigits: 2 })}
                                                    </span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // VehicleForm with receipt generation capability
        function VehicleForm({ vehicle, onSave, onCancel }) {
            const [formData, setFormData] = useState(vehicle || {
                brand: '',
                model: '',
                plate: '',
                vin: '',
                km: '',
                fuelType: 'benzina',
                taxRegime: 'margine',
                purchasePrice: '',
                salePrice: '',
                inStock: false,
                transportOrdered: false,
                delivered: false,
                sold: false,
                purchaseDate: new Date().toISOString().split('T')[0]
            });

            const [showReceiptModal, setShowReceiptModal] = useState(false);
            const [receiptData, setReceiptData] = useState({
                sellerName: '',
                sellerAddress: '',
                sellerCity: '',
                sellerFiscalCode: ''
            });

            const generateReceipt = async () => {
                if (!receiptData.sellerName) {
                    alert('Inserisci almeno il nome del venditore');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const receiptNumber = await getNextReceiptNumber();
                    const receiptNum = `RIC-${String(receiptNumber).padStart(3, '0')}`;

                    // Header
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TO.RI. MOTORS SRL', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Via Alcide De Gasperi 236', 105, 28, { align: 'center' });
                    doc.text('41058 Vignola (MO)', 105, 34, { align: 'center' });
                    doc.text('P.IVA/Cod. Fiscale: 04071771200', 105, 40, { align: 'center' });

                    // Receipt title and number
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RICEVUTA DI ACQUISTO', 105, 55, { align: 'center' });
                    
                    doc.setFontSize(12);
                    doc.text(`N. ${receiptNum}`, 105, 63, { align: 'center' });
                    doc.text(`Data: ${new Date(formData.purchaseDate).toLocaleDateString('it-IT')}`, 105, 70, { align: 'center' });

                    doc.setLineWidth(0.5);
                    doc.line(20, 75, 190, 75);

                    // Seller data
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DATI VENDITORE:', 20, 85);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text(`Nome: ${receiptData.sellerName}`, 20, 92);
                    if (receiptData.sellerAddress) doc.text(`Indirizzo: ${receiptData.sellerAddress}`, 20, 99);
                    if (receiptData.sellerCity) doc.text(`CittÃ : ${receiptData.sellerCity}`, 20, 106);
                    if (receiptData.sellerFiscalCode) doc.text(`Codice Fiscale: ${receiptData.sellerFiscalCode}`, 20, 113);

                    doc.line(20, 120, 190, 120);

                    // Vehicle data
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DATI VEICOLO:', 20, 130);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text(`Marca: ${formData.brand}`, 20, 137);
                    doc.text(`Modello: ${formData.model}`, 20, 144);
                    doc.text(`Targa: ${formData.plate}`, 20, 151);
                    doc.text(`Telaio (VIN): ${formData.vin}`, 20, 158);
                    doc.text(`Chilometri: ${parseInt(formData.km || 0).toLocaleString('it-IT')} km`, 20, 165);

                    doc.line(20, 172, 190, 172);

                    // Price
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PREZZO DI ACQUISTO:', 20, 185);
                    doc.setFontSize(16);
                    doc.text(`â‚¬ ${parseFloat(formData.purchasePrice || 0).toLocaleString('it-IT', { minimumFractionDigits: 2 })}`, 105, 185, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('(Importo al netto IVA)', 105, 192, { align: 'center' });

                    // Footer
                    doc.setFontSize(9);
                    doc.text('Documento generato automaticamente dal sistema TO.RI. MOTORS GEST', 105, 280, { align: 'center' });

                    // Save
                    doc.save(`Ricevuta_${receiptNum}_${formData.plate}.pdf`);
                    
                    alert(`âœ… Ricevuta ${receiptNum} generata con successo!`);
                    setShowReceiptModal(false);
                } catch (error) {
                    console.error('Error generating receipt:', error);
                    alert('Errore nella generazione della ricevuta');
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div className="bg-gradient-to-r from-slate-700 to-blue-800 text-white p-6">
                            <div className="flex items-center justify-between">
                                <h2 className="text-2xl font-bold">
                                    <i className="fas fa-car mr-2"></i>
                                    {vehicle ? 'Modifica Veicolo' : 'Nuovo Veicolo'}
                                </h2>
                                {vehicle && (
                                    <button
                                        onClick={() => setShowReceiptModal(true)}
                                        className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors"
                                    >
                                        <i className="fas fa-file-invoice mr-2"></i>
                                        Ricevuta
                                    </button>
                                )}
                            </div>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="p-6 space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Marca *</label>
                                    <input
                                        type="text"
                                        value={formData.brand}
                                        onChange={(e) => setFormData({ ...formData, brand: e.target.value })}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Modello *</label>
                                    <input
                                        type="text"
                                        value={formData.model}
                                        onChange={(e) => setFormData({ ...formData, model: e.target.value })}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Targa *</label>
                                    <input
                                        type="text"
                                        value={formData.plate}
                                        onChange={(e) => setFormData({ ...formData, plate: e.target.value.toUpperCase() })}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Telaio (VIN) *</label>
                                    <input
                                        type="text"
                                        value={formData.vin}
                                        onChange={(e) => setFormData({ ...formData, vin: e.target.value.toUpperCase() })}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Chilometri *</label>
                                    <input
                                        type="number"
                                        value={formData.km}
                                        onChange={(e) => setFormData({ ...formData, km: e.target.value })}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Alimentazione *</label>
                                    <select
                                        value={formData.fuelType}
                                        onChange={(e) => setFormData({ ...formData, fuelType: e.target.value })}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="benzina">Benzina</option>
                                        <option value="diesel">Diesel</option>
                                        <option value="benzina-metano">Benzina/Metano</option>
                                        <option value="benzina-gpl">Benzina/GPL</option>
                                        <option value="hybrid">Hybrid</option>
                                        <option value="elettrico">Elettrico</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Regime Fiscale *</label>
                                    <select
                                        value={formData.taxRegime}
                                        onChange={(e) => setFormData({ ...formData, taxRegime: e.target.value })}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="margine">Regime del Margine</option>
                                        <option value="iva">IVA Esposta (Netto)</option>
                                    </select>
                                </div>
                            </div>

                            <div className="border-t pt-6">
                                <h3 className="font-bold text-lg mb-4 text-gray-800">Prezzi (al netto IVA)</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Prezzo Acquisto (â‚¬) *</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={formData.purchasePrice}
                                            onChange={(e) => setFormData({ ...formData, purchasePrice: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            required
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Prezzo Vendita (â‚¬)</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={formData.salePrice}
                                            onChange={(e) => setFormData({ ...formData, salePrice: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Data Acquisto *</label>
                                        <input
                                            type="date"
                                            value={formData.purchaseDate}
                                            onChange={(e) => setFormData({ ...formData, purchaseDate: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            required
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="border-t pt-6">
                                <h3 className="font-bold text-lg mb-4 text-gray-800">Stato Logistica</h3>
                                <div className="space-y-3">
                                    <label className="flex items-center space-x-3 cursor-pointer p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                                        <input
                                            type="checkbox"
                                            checked={formData.inStock}
                                            onChange={(e) => setFormData({ ...formData, inStock: e.target.checked, transportOrdered: false, delivered: false })}
                                            className="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                                        />
                                        <div>
                                            <span className="text-gray-700 font-medium block">âœ… In Stock (ritirata direttamente)</span>
                                            <span className="text-xs text-gray-500">L'auto Ã¨ giÃ  disponibile in capannone</span>
                                        </div>
                                    </label>
                                    <label className="flex items-center space-x-3 cursor-pointer p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                                        <input
                                            type="checkbox"
                                            checked={formData.transportOrdered}
                                            onChange={(e) => setFormData({ ...formData, transportOrdered: e.target.checked, inStock: false })}
                                            className="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                                        />
                                        <div>
                                            <span className="text-gray-700 font-medium block">ðŸšš Trasporto Ordinato</span>
                                            <span className="text-xs text-gray-500">L'auto Ã¨ in viaggio, arriverÃ  al capannone</span>
                                        </div>
                                    </label>
                                    <label className="flex items-center space-x-3 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={formData.sold}
                                            onChange={(e) => setFormData({ ...formData, sold: e.target.checked })}
                                            className="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                                        />
                                        <span className="text-gray-700 font-medium">Venduta</span>
                                    </label>
                                </div>
                            </div>

                            <div className="flex justify-end space-x-3 pt-6 border-t">
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="px-6 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition-colors"
                                >
                                    Annulla
                                </button>
                                <button
                                    type="submit"
                                    className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
                                >
                                    <i className="fas fa-save mr-2"></i>
                                    Salva
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* Receipt Modal */}
                    {showReceiptModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] p-4">
                            <div className="bg-white rounded-lg shadow-2xl w-full max-w-md">
                                <div className="bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-t-lg">
                                    <h3 className="text-2xl font-bold">
                                        <i className="fas fa-file-invoice mr-2"></i>
                                        Genera Ricevuta
                                    </h3>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Nome Venditore *</label>
                                        <input
                                            type="text"
                                            value={receiptData.sellerName}
                                            onChange={(e) => setReceiptData({ ...receiptData, sellerName: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            placeholder="es. Mario Rossi"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Indirizzo</label>
                                        <input
                                            type="text"
                                            value={receiptData.sellerAddress}
                                            onChange={(e) => setReceiptData({ ...receiptData, sellerAddress: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            placeholder="es. Via Roma 123"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">CittÃ </label>
                                        <input
                                            type="text"
                                            value={receiptData.sellerCity}
                                            onChange={(e) => setReceiptData({ ...receiptData, sellerCity: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            placeholder="es. Bologna (BO)"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label>
                                        <input
                                            type="text"
                                            value={receiptData.sellerFiscalCode}
                                            onChange={(e) => setReceiptData({ ...receiptData, sellerFiscalCode: e.target.value.toUpperCase() })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            placeholder="es. RSSMRA80A01H501X"
                                        />
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-3 p-6 border-t">
                                    <button
                                        onClick={() => setShowReceiptModal(false)}
                                        className="px-6 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium"
                                    >
                                        Annulla
                                    </button>
                                    <button
                                        onClick={generateReceipt}
                                        className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium"
                                    >
                                        <i className="fas fa-download mr-2"></i>
                                        Genera PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Continue with VehicleDetail component...
        function VehicleDetail({ vehicle, onClose, onEdit, onDelete, onAddExpense, onDeleteExpense, onUpdate }) {
            const [showExpenseForm, setShowExpenseForm] = useState(false);
            const [newExpense, setNewExpense] = useState({ 
                description: '', 
                cost: '', 
                date: new Date().toISOString().split('T')[0],
                isQuickOption: false
            });
            const [showReceiptModal, setShowReceiptModal] = useState(false);
            const [receiptData, setReceiptData] = useState({
                sellerName: '',
                sellerAddress: '',
                sellerCity: '',
                sellerFiscalCode: ''
            });

            const totalExpenses = (vehicle.expenses || []).reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0);
            const totalCost = (parseFloat(vehicle.purchasePrice) || 0) + totalExpenses;
            const revenue = parseFloat(vehicle.salePrice) || 0;
            const margin = revenue - totalCost;
            const marginPercent = totalCost > 0 ? (margin / totalCost * 100) : 0;

            const handleAddExpense = () => {
                if (newExpense.description && newExpense.cost) {
                    onAddExpense(vehicle.id, newExpense);
                    setNewExpense({ description: '', cost: '', date: new Date().toISOString().split('T')[0], isQuickOption: false });
                    setShowExpenseForm(false);
                }
            };

            const addQuickExpense = (description, defaultCost = '') => {
                setNewExpense({
                    description,
                    cost: defaultCost,
                    date: new Date().toISOString().split('T')[0],
                    isQuickOption: true
                });
                setShowExpenseForm(true);
            };

            const handleDelivered = () => {
                onUpdate(vehicle.id, { 
                    delivered: true,
                    inStock: true,
                    transportOrdered: false
                });
            };

            const generateReceipt = async () => {
                if (!receiptData.sellerName) {
                    alert('Inserisci almeno il nome del venditore');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const receiptNumber = await getNextReceiptNumber();
                    const receiptNum = `RIC-${String(receiptNumber).padStart(3, '0')}`;

                    // Header
                    doc.setFontSize(20);
                    doc.setFont('helvetica', 'bold');
                    doc.text('TO.RI. MOTORS SRL', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Via Alcide De Gasperi 236', 105, 28, { align: 'center' });
                    doc.text('41058 Vignola (MO)', 105, 34, { align: 'center' });
                    doc.text('P.IVA/Cod. Fiscale: 04071771200', 105, 40, { align: 'center' });

                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RICEVUTA DI ACQUISTO', 105, 55, { align: 'center' });
                    
                    doc.setFontSize(12);
                    doc.text(`N. ${receiptNum}`, 105, 63, { align: 'center' });
                    doc.text(`Data: ${new Date(vehicle.purchaseDate || new Date()).toLocaleDateString('it-IT')}`, 105, 70, { align: 'center' });

                    doc.setLineWidth(0.5);
                    doc.line(20, 75, 190, 75);

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DATI VENDITORE:', 20, 85);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text(`Nome: ${receiptData.sellerName}`, 20, 92);
                    if (receiptData.sellerAddress) doc.text(`Indirizzo: ${receiptData.sellerAddress}`, 20, 99);
                    if (receiptData.sellerCity) doc.text(`CittÃ : ${receiptData.sellerCity}`, 20, 106);
                    if (receiptData.sellerFiscalCode) doc.text(`Codice Fiscale: ${receiptData.sellerFiscalCode}`, 20, 113);

                    doc.line(20, 120, 190, 120);

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('DATI VEICOLO:', 20, 130);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.text(`Marca: ${vehicle.brand}`, 20, 137);
                    doc.text(`Modello: ${vehicle.model}`, 20, 144);
                    doc.text(`Targa: ${vehicle.plate}`, 20, 151);
                    doc.text(`Telaio (VIN): ${vehicle.vin}`, 20, 158);
                    doc.text(`Chilometri: ${parseInt(vehicle.km || 0).toLocaleString('it-IT')} km`, 20, 165);

                    doc.line(20, 172, 190, 172);

                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('PREZZO DI ACQUISTO:', 20, 185);
                    doc.setFontSize(16);
                    doc.text(`â‚¬ ${parseFloat(vehicle.purchasePrice || 0).toLocaleString('it-IT', { minimumFractionDigits: 2 })}`, 105, 185, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text('(Importo al netto IVA)', 105, 192, { align: 'center' });

                    doc.setFontSize(9);
                    doc.text('Documento generato automaticamente dal sistema TO.RI. MOTORS GEST', 105, 280, { align: 'center' });

                    doc.save(`Ricevuta_${receiptNum}_${vehicle.plate}.pdf`);
                    
                    alert(`âœ… Ricevuta ${receiptNum} generata con successo!`);
                    setShowReceiptModal(false);
                } catch (error) {
                    console.error('Error generating receipt:', error);
                    alert('Errore nella generazione della ricevuta');
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl my-8">
                        <div className="bg-gradient-to-r from-slate-700 to-blue-800 text-white p-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h2 className="text-3xl font-bold mb-2">{vehicle.brand} {vehicle.model}</h2>
                                    <p className="text-slate-200">{vehicle.plate} â€¢ VIN: {vehicle.vin}</p>
                                </div>
                                <button onClick={onClose} className="text-white hover:text-gray-300">
                                    <i className="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                        </div>

                        <div className="p-6 space-y-6">
                            <div className="flex flex-wrap gap-3">
                                <button onClick={onEdit} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                    <i className="fas fa-edit mr-2"></i>Modifica
                                </button>
                                <button onClick={() => onDelete(vehicle.id)} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                                    <i className="fas fa-trash mr-2"></i>Elimina
                                </button>
                                <button
                                    onClick={() => setShowReceiptModal(true)}
                                    className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"
                                >
                                    <i className="fas fa-file-invoice mr-2"></i>Ricevuta
                                </button>
                                {!vehicle.inStock && (
                                    <button
                                        onClick={() => onUpdate(vehicle.id, { inStock: true, transportOrdered: false, delivered: false })}
                                        className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg"
                                    >
                                        <i className="fas fa-warehouse mr-2"></i>Segna In Stock
                                    </button>
                                )}
                                {!vehicle.transportOrdered && !vehicle.inStock && (
                                    <button
                                        onClick={() => onUpdate(vehicle.id, { transportOrdered: true, inStock: false })}
                                        className="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg"
                                    >
                                        <i className="fas fa-truck mr-2"></i>Ordina Trasporto
                                    </button>
                                )}
                                {vehicle.transportOrdered && !vehicle.delivered && (
                                    <button
                                        onClick={handleDelivered}
                                        className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"
                                    >
                                        <i className="fas fa-check mr-2"></i>Segna Consegnata
                                    </button>
                                )}
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <p className="text-sm text-gray-600 mb-1">Chilometri</p>
                                    <p className="font-bold text-lg">{parseInt(vehicle.km || 0).toLocaleString('it-IT')} km</p>
                                </div>
                                {vehicle.fuelType && (
                                    <div className="bg-gray-50 p-4 rounded-lg">
                                        <p className="text-sm text-gray-600 mb-1">Alimentazione</p>
                                        <p className="font-bold text-lg text-green-600">
                                            {vehicle.fuelType === 'benzina' && 'â›½ Benzina'}
                                            {vehicle.fuelType === 'diesel' && 'ðŸš› Diesel'}
                                            {vehicle.fuelType === 'benzina-metano' && 'â›½ðŸ”µ Metano'}
                                            {vehicle.fuelType === 'benzina-gpl' && 'â›½ðŸŸ  GPL'}
                                            {vehicle.fuelType === 'hybrid' && 'ðŸ”‹ Hybrid'}
                                            {vehicle.fuelType === 'elettrico' && 'âš¡ Elettrico'}
                                        </p>
                                    </div>
                                )}
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <p className="text-sm text-gray-600 mb-1">Regime Fiscale</p>
                                    <p className="font-bold text-lg">{vehicle.taxRegime === 'margine' ? 'Margine' : 'IVA Esposta'}</p>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-lg">
                                    <p className="text-sm text-gray-600 mb-1">Stato</p>
                                    <div className="flex flex-wrap gap-1">
                                        {!vehicle.transportOrdered && !vehicle.inStock && <span className="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full">Da Trasportare</span>}
                                        {vehicle.inStock && <span className="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full">In Stock</span>}
                                        {vehicle.transportOrdered && !vehicle.delivered && <span className="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full">In Arrivo</span>}
                                        {vehicle.delivered && <span className="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">Disponibile</span>}
                                        {vehicle.sold && <span className="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full">Venduta</span>}
                                    </div>
                                </div>
                            </div>

                            <div className="bg-gradient-to-br from-slate-50 to-blue-50 rounded-lg p-6 border border-blue-200">
                                <h3 className="font-bold text-lg mb-4"><i className="fas fa-calculator mr-2 text-blue-600"></i>Riepilogo Finanziario</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="space-y-2">
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">Prezzo Acquisto (netto)</span>
                                            <span className="font-semibold">â‚¬{parseFloat(vehicle.purchasePrice || 0).toLocaleString('it-IT', { minimumFractionDigits: 2 })}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">Spese Ricambi</span>
                                            <span className="font-semibold text-orange-600">+ â‚¬{totalExpenses.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</span>
                                        </div>
                                        <div className="flex justify-between pt-2 border-t-2">
                                            <span className="font-bold">COSTO TOTALE</span>
                                            <span className="font-bold text-xl">â‚¬{totalCost.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</span>
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">Prezzo Vendita (netto)</span>
                                            <span className="font-semibold">â‚¬{revenue.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</span>
                                        </div>
                                        <div className="flex justify-between pt-2 border-t-2">
                                            <span className="font-bold">MARGINE REALE</span>
                                            <div className="text-right">
                                                <span className={`font-bold text-xl ${margin >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    â‚¬{margin.toLocaleString('it-IT', { minimumFractionDigits: 2 })}
                                                </span>
                                                <p className={`text-sm ${margin >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    ({marginPercent.toFixed(1)}%)
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="border-t pt-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg"><i className="fas fa-receipt mr-2 text-blue-600"></i>Spese e Ricambi</h3>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => addQuickExpense('Minipassaggio', '')}
                                            className="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg text-sm"
                                        >
                                            <i className="fas fa-file-signature mr-1"></i>Minipassaggio
                                        </button>
                                        <button
                                            onClick={() => addQuickExpense('Trasporto', '')}
                                            className="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg text-sm"
                                        >
                                            <i className="fas fa-truck mr-1"></i>Trasporto
                                        </button>
                                        <button
                                            onClick={() => setShowExpenseForm(!showExpenseForm)}
                                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
                                        >
                                            <i className="fas fa-plus mr-2"></i>Altra Spesa
                                        </button>
                                    </div>
                                </div>

                                {showExpenseForm && (
                                    <div className="bg-gray-50 p-4 rounded-lg mb-4 space-y-3">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                            <input
                                                type="text"
                                                placeholder="Descrizione"
                                                value={newExpense.description}
                                                onChange={(e) => setNewExpense({ ...newExpense, description: e.target.value })}
                                                className="px-4 py-2 border rounded-lg"
                                            />
                                            <input
                                                type="number"
                                                step="0.01"
                                                placeholder="Costo (netto)"
                                                value={newExpense.cost}
                                                onChange={(e) => setNewExpense({ ...newExpense, cost: e.target.value })}
                                                className="px-4 py-2 border rounded-lg"
                                                autoFocus
                                            />
                                            <input
                                                type="date"
                                                value={newExpense.date}
                                                onChange={(e) => setNewExpense({ ...newExpense, date: e.target.value })}
                                                className="px-4 py-2 border rounded-lg"
                                            />
                                        </div>
                                        <div className="flex justify-end space-x-2">
                                            <button onClick={() => setShowExpenseForm(false)} className="px-4 py-2 bg-gray-200 rounded-lg">Annulla</button>
                                            <button onClick={handleAddExpense} className="px-4 py-2 bg-green-600 text-white rounded-lg">Salva</button>
                                        </div>
                                    </div>
                                )}

                                {(vehicle.expenses || []).length === 0 ? (
                                    <p className="text-center text-gray-500 py-8">Nessuna spesa registrata</p>
                                ) : (
                                    <div className="space-y-2">
                                        {vehicle.expenses.map(exp => (
                                            <div key={exp.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p className="font-medium">{exp.description}</p>
                                                    <p className="text-sm text-gray-500">{new Date(exp.date).toLocaleDateString('it-IT')}</p>
                                                </div>
                                                <div className="flex items-center space-x-3">
                                                    <span className="font-bold text-orange-600">â‚¬{parseFloat(exp.cost).toLocaleString('it-IT', { minimumFractionDigits: 2 })}</span>
                                                    <button onClick={() => onDeleteExpense(vehicle.id, exp.id)} className="text-red-600 hover:text-red-800">
                                                        <i className="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Receipt Modal */}
                    {showReceiptModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] p-4">
                            <div className="bg-white rounded-lg shadow-2xl w-full max-w-md">
                                <div className="bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-t-lg">
                                    <h3 className="text-2xl font-bold">
                                        <i className="fas fa-file-invoice mr-2"></i>
                                        Genera Ricevuta
                                    </h3>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Nome Venditore *</label>
                                        <input
                                            type="text"
                                            value={receiptData.sellerName}
                                            onChange={(e) => setReceiptData({ ...receiptData, sellerName: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            placeholder="es. Mario Rossi"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Indirizzo</label>
                                        <input
                                            type="text"
                                            value={receiptData.sellerAddress}
                                            onChange={(e) => setReceiptData({ ...receiptData, sellerAddress: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            placeholder="es. Via Roma 123"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">CittÃ </label>
                                        <input
                                            type="text"
                                            value={receiptData.sellerCity}
                                            onChange={(e) => setReceiptData({ ...receiptData, sellerCity: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            placeholder="es. Bologna (BO)"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label>
                                        <input
                                            type="text"
                                            value={receiptData.sellerFiscalCode}
                                            onChange={(e) => setReceiptData({ ...receiptData, sellerFiscalCode: e.target.value.toUpperCase() })}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                            placeholder="es. RSSMRA80A01H501X"
                                        />
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-3 p-6 border-t">
                                    <button
                                        onClick={() => setShowReceiptModal(false)}
                                        className="px-6 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium"
                                    >
                                        Annulla
                                    </button>
                                    <button
                                        onClick={generateReceipt}
                                        className="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium"
                                    >
                                        <i className="fas fa-download mr-2"></i>
                                        Genera PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Logistica({ vehicles, onSelectVehicle }) {
            const toTransport = vehicles.filter(v => !v.transportOrdered && !v.inStock);
            const inStock = vehicles.filter(v => v.inStock && !v.sold);
            const inTransit = vehicles.filter(v => v.transportOrdered && !v.delivered);
            const delivered = vehicles.filter(v => v.delivered && !v.sold);

            const Section = ({ title, vehicles, icon, color }) => (
                <div className="bg-white rounded-lg shadow">
                    <div className={`${color} text-white p-4 rounded-t-lg`}>
                        <h3 className="font-bold text-lg">
                            <i className={`fas ${icon} mr-2`}></i>
                            {title} ({vehicles.length})
                        </h3>
                    </div>
                    <div className="p-4">
                        {vehicles.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">Nessun veicolo</p>
                        ) : (
                            <div className="space-y-2">
                                {vehicles.map(v => (
                                    <div key={v.id} onClick={() => onSelectVehicle(v)} className="flex justify-between items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                        <div>
                                            <p className="font-semibold">{v.brand} {v.model}</p>
                                            <p className="text-sm text-gray-500">{v.plate}</p>
                                        </div>
                                        <i className="fas fa-chevron-right text-gray-400"></i>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="p-4 lg:p-6 space-y-6">
                    <h1 className="text-2xl lg:text-3xl font-bold text-gray-800">
                        <i className="fas fa-truck mr-3 text-blue-600"></i>
                        Logistica e Trasporti
                    </h1>
                    <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                        <Section title="Da Trasportare" vehicles={toTransport} icon="fa-clock" color="bg-orange-500" />
                        <Section title="In Stock" vehicles={inStock} icon="fa-warehouse" color="bg-purple-500" />
                        <Section title="In Arrivo" vehicles={inTransit} icon="fa-truck-moving" color="bg-yellow-500" />
                        <Section title="Consegnate" vehicles={delivered} icon="fa-check-circle" color="bg-green-500" />
                    </div>
                </div>
            );
        }

        function AnalisiMargini({ vehicles }) {
            const soldVehicles = vehicles.filter(v => v.sold);
            
            const analytics = soldVehicles.map(v => {
                const expenses = (v.expenses || []).reduce((sum, e) => sum + (parseFloat(e.cost) || 0), 0);
                const totalCost = (parseFloat(v.purchasePrice) || 0) + expenses;
                const revenue = parseFloat(v.salePrice) || 0;
                const margin = revenue - totalCost;
                const marginPercent = totalCost > 0 ? (margin / totalCost * 100) : 0;
                return { ...v, totalCost, revenue, margin, marginPercent, expenses };
            });

            const totalMargin = analytics.reduce((sum, v) => sum + v.margin, 0);
            const avgMarginPercent = analytics.length > 0 ? analytics.reduce((sum, v) => sum + v.marginPercent, 0) / analytics.length : 0;
            const totalInvested = vehicles.filter(v => !v.sold).reduce((sum, v) => sum + (parseFloat(v.purchasePrice) || 0) + ((v.expenses || []).reduce((s, e) => s + (parseFloat(e.cost) || 0), 0)), 0);

            return (
                <div className="p-4 lg:p-6 space-y-6">
                    <h1 className="text-2xl lg:text-3xl font-bold text-gray-800">
                        <i className="fas fa-chart-line mr-3 text-blue-600"></i>
                        Analisi Margini
                    </h1>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
                            <p className="text-sm text-gray-600 mb-1">Margine Totale</p>
                            <p className="text-3xl font-bold text-green-600">â‚¬{totalMargin.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</p>
                            <p className="text-sm text-gray-500 mt-2">{soldVehicles.length} auto vendute</p>
                        </div>
                        <div className="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
                            <p className="text-sm text-gray-600 mb-1">Margine Medio %</p>
                            <p className="text-3xl font-bold text-blue-600">{avgMarginPercent.toFixed(1)}%</p>
                        </div>
                        <div className="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
                            <p className="text-sm text-gray-600 mb-1">Capitale Investito</p>
                            <p className="text-3xl font-bold text-purple-600">â‚¬{totalInvested.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</p>
                            <p className="text-sm text-gray-500 mt-2">{vehicles.length - soldVehicles.length} auto in stock</p>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="p-6 border-b">
                            <h2 className="text-xl font-bold">Dettaglio Vendite</h2>
                        </div>
                        {soldVehicles.length === 0 ? (
                            <p className="text-center text-gray-500 py-12">Nessuna auto venduta</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Veicolo</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acquisto</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Spese</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Costo Tot.</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Vendita</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Margine</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">%</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {analytics.map(v => (
                                            <tr key={v.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4">
                                                    <p className="font-semibold">{v.brand} {v.model}</p>
                                                    <p className="text-sm text-gray-500">{v.plate}</p>
                                                </td>
                                                <td className="px-6 py-4 text-right">â‚¬{parseFloat(v.purchasePrice || 0).toLocaleString('it-IT', { minimumFractionDigits: 2 })}</td>
                                                <td className="px-6 py-4 text-right text-orange-600">â‚¬{v.expenses.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</td>
                                                <td className="px-6 py-4 text-right font-semibold">â‚¬{v.totalCost.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</td>
                                                <td className="px-6 py-4 text-right">â‚¬{v.revenue.toLocaleString('it-IT', { minimumFractionDigits: 2 })}</td>
                                                <td className={`px-6 py-4 text-right font-bold ${v.margin >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    â‚¬{v.margin.toLocaleString('it-IT', { minimumFractionDigits: 2 })}
                                                </td>
                                                <td className={`px-6 py-4 text-right font-semibold ${v.marginPercent >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {v.marginPercent.toFixed(1)}%
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }
    </script>
</body>
</html>
